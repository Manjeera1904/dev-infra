name: Security_Vulnerability_Scan_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

pool:
  vmImage: ubuntu-latest

steps:
- checkout: self
  persistCredentials: true   # REQUIRED for OAuth token

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: |
    pip install requests
  displayName: Install Python dependencies

- script: |
    python - <<EOF
    import json, subprocess, os

    # OAuth token from pipeline
    token = os.environ["SYSTEM_ACCESSTOKEN"]

    with open(".azure-pipelines/maintenance/scripts/security/repo-list.json") as f:
        repos = json.load(f)

    for repo in repos:
        env = os.environ.copy()
        env["TARGET_REPO"] = repo
        env["SYSTEM_ACCESSTOKEN"] = token  # pass token to scripts

        subprocess.run([
            "bash",
            ".azure-pipelines/maintenance/scripts/security/scan-repo.sh",
            repo,
            token
        ], env=env)
    EOF
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  displayName: Scan all repositories and create Bugs
